(auth_required) {
	forward_auth authelia:9091 {
		uri /api/authz/forward-auth?authelia_url=https://authelia.{$MY_DOMAIN}
		copy_headers Remote-User Remote-Groups Remote-Email Remote-Name
	}
}
(common) {
	encode zstd gzip
	header {
		-server
		-x-powered-by
	}
}

{
	# Disable admin API.
	admin off
	# Handle plain HTTP/1 and encrypted HTTP/2 through fd 4.
	default_bind fd/4 {
		protocols h1 h2
	}
	# Handle HTTP/3 through fd 5.
	default_bind fdgram/5 {
		protocols h3
	}
	# Disable automatic HTTPS redir as we do it manually, using fd.
	auto_https disable_redirects
	log {
		level warn
	}
}

http:// {
	bind fd/3 {
		protocols h1
	}
	redir https://{host}{uri}
}

{$MY_DOMAIN} {
	import auth_required
	import common
	reverse_proxy homepage:3000
}

import subdomains/*
